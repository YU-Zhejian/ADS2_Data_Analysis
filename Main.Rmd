---
title: "Report"
author: "ADS2 Group 4"
date: "`r Sys.time()`"
output:
  pdf_document:
    toc: yes
    number_sections: yes
    toc_depth: 5
    keep_tex: yes
    latex_engine: pdflatex
    df_print: tibble
geometry: inner=0.5in,outer=0.5in
---


# Global Libraries

Locating global libraries.

```{r Global libraries}
# Remove cached variables
rm(list = ls())
# Knitr Options
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Check whether the dependencies are met
installed <- installed.packages()[, 1]
required <- c("tidyverse", "ggubr", "knitr", "rmarkdown", "stringr", "viridis", "C50", "pheatmap")
for (packages in required) {
  if (!packages %in% installed) {
    simpleError(paste0("Package ", packages, " not installed."))
  }
}
rm(installed)
rm(packages)
# Source global packages
library(tidyverse)
library(C50)
library(ggpubr)
library(viridis)
library(pheatmap)
```

# Data Cleaning

```{r Read Data}
if (!file.exists("substance_use.csv")) simpleError(paste0("File substance_use.csv not exist!"))
sub_use <- read.csv("substance_use.csv", stringsAsFactors = TRUE)
```

Use `head` and `summary` to explore data.

```{r Summary}
summary(sub_use)
slice_head(sub_use, n = 3)
```

We discovered that there is only `"Percent"` in the `metric` column. This column is therefore removed.

```{r Remove metric}
summary(factor(sub_use$metric))
sub_use <- select(sub_use, !(metric))
```

Check whether there are `NA`s inside.

```{r deNA}
summary(complete.cases(sub_use))
```

It is clear that there is no `NA` inside.

# Part 1: Exploring the Data

## Question 1: Which region of the word have the highest rate of alcohol-related deaths among man aged 40-44 in 2019?

To solve this problem, we need to filter out the data, reversely sort the data by value and pick the first one.

```{r P1Q1}
# Get all data satisfying the criteria
sub_use40_44 <- sub_use[sub_use$year == 2019 &
                          sub_use$sex == "Male" &
                          sub_use$cause == "Alcohol use disorders" &
                          sub_use$age == "40 to 44" &
                          sub_use$measure == "Deaths",]
# Sort the result by val in reverse order
sub_use_arranged <- arrange(sub_use40_44, desc(val))
# Pick the highest one and get its location
sub_use_arranged[1, "location"]
rm(sub_use40_44)
rm(sub_use_arranged)
```

From above we can know that the "Europe & Central Asia - WB" region of the world has the highest rate of alcohol-related deaths among man aged 40-44 in 2019

## Question 2: Looking at the prevalence of alcohol-related disease in the East Asia and Pacific region, how has this changed over time and in the different age groups? Is there a difference between men and women?

A plot is needed for this question.

```{r P1Q2.1}
sub_use_alcohol <- sub_use[sub_use$measure == "Prevalence" &
                             sub_use$location == "East Asia & Pacific - WB" &
                             sub_use$cause == "Alcohol use disorders",]

g <- ggplot(sub_use_alcohol, aes(x = year, y = val, color = age, shape = sex)) +
  geom_point(show.legend = TRUE) +
  geom_line(show.legend = TRUE) +
  facet_grid(. ~ sex) +
  labs(title = "prevalence of alcohol-related disease in the East Asia and Pacific region",
       x = "Year", y = "Prevalence") +
  scale_color_viridis(discrete = T)
g
```

From the graph, we can know that:

* For males, the prevalence of alcohol-related disease in the East Asia and Pacific region rises from 1990 to 1995, and decreases to 2005, and then rise again non-stop for those who aged 25 to 54. For those who are 55 to 69, they reached to peak in about 2017 and decreases afterwards.
* Comparing to males, there are no significant changes in females.

To determine whether there is a difference between man and woman, we plot a violin plot as statistical tests are explicitly announced to be unnecessary.

```{r P1Q2.2}
g <- ggplot(sub_use_alcohol) +
  geom_violin(aes(x = sex, y = val, fill = sex), show.legend = TRUE) +
  labs(title = "Prevalence of alcohol-related disease in the East Asia and Pacific region",
       x = "Gender", y = "Prevalence") +
  scale_fill_manual(values = c("#E69F00", "#56B4E9"))
g
rm(sub_use_alcohol)
rm(g)
```

From this violin plot, we can conclude that there is a difference between male and female. Female is significantly lower than male.

## Question 3: Looking at the data from the United States, can you confirm an increase in the prevalence of diseases related to opioid use? What age group is the most affected?

The remaining part of the description is:

> In the United States, there is talk of an "Opioid epidemic". Part of the problem is that since the late 1990s, doctors have increasingly been prescribing pain killers which can be highly addictive.

Firstly we need to plot how is the prevalence of diseases is related to opioid use.

```{r P1Q3}
sub_use_Opioid <- sub_use[sub_use$measure == "Deaths" &
                            sub_use$location == "North America" &
                            sub_use$cause == "Opioid use disorders",]

g <- ggplot(sub_use_Opioid, aes(x = year, y = val, color = age)) +
  geom_point(show.legend = TRUE) +
  geom_line(show.legend = TRUE) +
  labs(title = "Prevalence of opioid-related disease in the United States",
       x = "Year", y = "Prevalence") +
  facet_grid(. ~ sex) +
  scale_color_viridis(discrete = T)
g
rm(sub_use_Opioid)
rm(g)
```

So, from the graph, it is clear that an increase in the prevalence of diseases related to opioid use can be confirmed. Males aging from 25-29 are mostly affected.

# Part 2: Ask your own Question

In this part, we will build a classification tree model using C5.0 algorithm provided by R package `C50`. The following part reveals the training process, and the question we ask will be stated below.

```{r Training}
sub_use_rand <- sub_use[order(runif(15000)),]
train <- slice_head(sub_use_rand, n = 15000 / 2)
train.data <- select(train, !(location))
train.label <- train$location
test <- slice_tail(sub_use_rand, n = 15000 / 2)
test.data <- select(test, !(location))
test.label <- test$location
test.location <- unique(as.character(test.label))

# Training the model
m <- C5.0(train.data, train.label, trials = 100)

rm(sub_use_rand)
rm(train)
rm(train.data)
rm(train.label)
rm(test)
```

The following table shows factors that do matter in this module.

```{r Factors}
#Print the usage attribute
attributeUsage <- strsplit(m$output, "Attribute usage")[[1]][2]
cat(attributeUsage)
rm(attributeUsage)
```

The following graph shows the error rate, from which we can know that this model is over-fitting.

```{r Error Rate}
err <- m$boostResults
ggscatter(err, x = "Trial", y = "Percent", add = "reg.line",
          add.params = list(color = "blue", fill = "lightgray"), conf.int = TRUE) +
  geom_line()
rm(err)
```

The following piece of code performs the prediction.

```{r Prediction}
pred <- predict(m, test.data, type = "class")
rm(test.data)
```

The following graph shows the confusion matrix, both unnormalized and normalized with Log-Normalize.

```{r Confusion Matrix}
pred <- as.character(pred)
test.label <- as.character(test.label)
df <- as.data.frame(matrix(0,
                           nrow = length(test.location),
                           ncol = length(test.location)),
                    row.names = test.location)
names(df) <- test.location
for (i in seq(1, length(pred))) {
  df[pred[i], test.label[i]] <- df[pred[i], test.label[i]] + 1
}
pheatmap(df, cluster_cols = FALSE, cluster_rows = FALSE,
         display_numbers = TRUE)
# log normalize
pheatmap(log10(df + 1), cluster_cols = FALSE, cluster_rows = FALSE,
         display_numbers = TRUE)
rm(df)
rm(i)
rm(test.label)
rm(test.location)
```

## Question 4: TODO

# Cleaning Up

```{r Cleaning Up}
rm(m)
rm(pred)
rm(sub_use)
```

# Supplementary Code

This RMarkdown should be compiled with following code:

```{r Compile, eval = FALSE}
library(rmarkdown)
library(knitr)
eng_text <- function(options) {
  engine_output(options, code = options$code, out = "")
}
knit_engines$set(text = eng_text)
render("Main.Rmd", output_format = "all")
```
